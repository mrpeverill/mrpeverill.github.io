<!DOCTYPE html>
<html lang="en">

  <!-- Head -->
  <head>    <!-- Metadata, OpenGraph and Schema.org -->
    

    <!-- Standard metadata -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Matthew  Peverill | On transporting FSL designs to SPM</title>
    <meta name="author" content="Matthew  Peverill" />
    <meta name="description" content="Clinical Scientist and  Psychologist in Training 
" />
    <meta name="keywords" content="academic-website, portfolio-website, neuroscience, clinical-psychology" />


    <!-- Bootstrap & MDB -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous" />

    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons">

    <!-- Code Syntax Highlighting -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="none" id="highlight_theme_light" />

    <!-- Styles -->
    
    <link rel="shortcut icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ§ </text></svg>">
    
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="canonical" href="https://matthewpeverill.com/blog/2018/on-transporting-fsl-designs-to-spm/">
    
    <!-- Dark Mode -->
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark" />

    <script src="/assets/js/theme.js"></script>
    <script src="/assets/js/dark_mode.js"></script>
    

  </head>

  <!-- Body -->
  <body class="fixed-top-nav ">

    <!-- Header -->
    <header>

      <!-- Nav Bar -->
      <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top">
        <div class="container">
          <a class="navbar-brand title font-weight-lighter" href="https://matthewpeverill.com/"><span class="font-weight-bold">Matthew</span>   Peverill</a>
          <!-- Navbar Toggle -->
          <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar top-bar"></span>
            <span class="icon-bar middle-bar"></span>
            <span class="icon-bar bottom-bar"></span>
          </button>

          <div class="collapse navbar-collapse text-right" id="navbarNav">
            <ul class="navbar-nav ml-auto flex-nowrap">

              <!-- About -->
              <li class="nav-item ">
                <a class="nav-link" href="/">about</a>
              </li>
              
              <!-- Blog -->
              <li class="nav-item active">
                <a class="nav-link" href="/blog/">blog</a>
              </li>

              <!-- Other pages -->
              <li class="nav-item ">
                <a class="nav-link" href="/projects/">projects</a>
              </li>
              <li class="nav-item ">
                <a class="nav-link" href="/publications/">publications</a>
              </li>
              <li class="nav-item ">
                <a class="nav-link" href="/CV/">vitae</a>
              </li>

              <!-- Toogle theme mode -->
              <div class="toggle-container">
                <a id="light-toggle">
                  <i class="fas fa-moon"></i>
                  <i class="fas fa-sun"></i>
                </a>
              </div>
            </ul>
          </div>
        </div>
      </nav>
    </header>

    <!-- Content -->
    <div class="container mt-5">
      <!-- _layouts/post.html -->

<div class="post">

  <header class="post-header">
    <h1 class="post-title">On transporting FSL designs to SPM</h1>
    <p class="post-meta">March 8, 2018</p>
    <p class="post-tags">
      <a href="/blog/2018"> <i class="fas fa-calendar fa-sm"></i> 2018 </a>

    </p>
  </header>

  <article class="post-content">
    <h1>Introduction</h1>

<p>Letâ€™s say, just hypothetically, that you built a first-level analysis pipeline in FSL but are then find you need to run SPM code on it. You might wish there was a way to easily convert your design in to an SPM readable format. Here are a few notes on that process, along with a python script to actually output a timing.mat file:</p>

<h1>Inputting 4d data</h1>

<p>If you are used to working with FSL, you are probably using 4d .nii files. Fortunately, SPM8 can open these (my understanding is that this didnâ€™t used to be the case). BUT you have to specify which volumes of the files you want to examine. So if your scan selection says â€˜Run1.nii,1â€™ - that means youâ€™ve only selected the first volume. Your batch is going to fail with â€˜Cell contents reference from a non-cell array object.â€™ which might, hypothetically, cause you to spend a few days wondering what is wrong with your timing file. That would be frustrating.</p>

<p>Instead, what you need to do is change the window that reads â€˜1â€™ under the filter box in the file selection window to 1:999, like so:</p>

<p><a href="https://matthewpeverill.com/assets/img/2015/10/spm-multi-volume-select.png"><img class="alignnone size-medium wp-image-3" src="https://matthewpeverill.com/assets/img/2015/10/spm-multi-volume-select.png?w=300" alt="SPM Multi-Volume Select" width="300" height="91"></a></p>

<p>You will see all the volumes appear in the list. Select them all and press â€˜Doneâ€™. Now you are ready to go!</p>

<p><a href="https://en.wikibooks.org/wiki/SPM/Working_with_4D_data" target="_blank" rel="noopener noreferrer">The SPM Wikibook has more info on working with 4d data</a></p>
<h1>Adding your timings</h1>
<p>So, using the GUI, you can enter your conditions with names, onsets, and durations as separate vectors, but thatâ€™s annoying. You can also specify a .mat file containing three cell arrays with those values, which is less annoying but you still have to transcribe from your carefully produced three column FSL event file. If only you had a script to do that for youâ€¦</p>

<p>Here is that script:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1">#This script takes any number of three column fsl event files and outputs a .m matlab script suitable for generating timing parameters. 
</span><span class="kn">import</span> <span class="n">sys</span>
<span class="kn">import</span> <span class="n">pandas</span>
<span class="c1">#from decimal import Decimal 
</span><span class="k">print</span> <span class="sh">'</span><span class="s">Number of arguments:</span><span class="sh">'</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]),</span> <span class="sh">'</span><span class="s">arguments.</span><span class="sh">'</span>
<span class="k">print</span> <span class="sh">'</span><span class="s">Argument List:</span><span class="sh">'</span><span class="p">,</span> <span class="nf">str</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

<span class="n">llist</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">names=cell(1,%s);</span><span class="sh">'</span> <span class="o">%</span> <span class="nf">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]),</span>
 <span class="sh">'</span><span class="s">onsets=cell(1,%s);</span><span class="sh">'</span> <span class="o">%</span> <span class="nf">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]),</span>
 <span class="sh">'</span><span class="s">durations=cell(1,%s);</span><span class="sh">'</span> <span class="o">%</span> <span class="nf">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:])]</span>

<span class="c1">#Get the EVs from the fsl files. 
</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
 <span class="k">try</span><span class="p">:</span>
 <span class="n">f</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
 <span class="k">except</span><span class="p">:</span>
 <span class="k">print</span> <span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">Could</span> <span class="ow">not</span> <span class="nb">open</span> <span class="nb">file</span> <span class="o">%</span><span class="n">s</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span> <span class="o">%</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
 <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
 <span class="n">df</span> <span class="o">=</span> <span class="n">pandas</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">delim_whitespace</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="bp">None</span><span class="p">).</span><span class="nf">sort_index</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
 <span class="n">llist</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">names</span><span class="p">{</span><span class="o">%</span><span class="n">s</span><span class="p">}</span><span class="o">=</span><span class="sh">'</span><span class="s">%s</span><span class="sh">'</span><span class="p">;</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
 <span class="c1">#This is awful, sorry: 
</span> <span class="n">llist</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">onsets</span><span class="p">{</span><span class="o">%</span><span class="n">s</span><span class="p">}</span><span class="o">=</span><span class="p">[</span><span class="o">%</span><span class="n">s</span><span class="p">];</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;{</span><span class="mi">0</span><span class="p">:.</span><span class="mi">4</span><span class="n">f</span><span class="p">}</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;.</span><span class="nf">format</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">tolist</span><span class="p">()])))</span>
 <span class="n">llist</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">durations</span><span class="p">{</span><span class="o">%</span><span class="n">s</span><span class="p">}</span><span class="o">=%</span><span class="n">s</span><span class="p">;</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nf">str</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">tolist</span><span class="p">())))</span>
 <span class="n">f</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>

<span class="n">w</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="sh">'</span><span class="s">output.m</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">w</span><span class="sh">'</span><span class="p">)</span>
<span class="k">print</span> <span class="sh">'</span><span class="s">output.m file text</span><span class="sh">'</span>
<span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">llist</span><span class="p">:</span>
 <span class="k">print</span> <span class="n">l</span>
 <span class="n">w</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="o">%</span><span class="n">s</span>\<span class="n">n</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span> <span class="o">%</span> <span class="n">l</span><span class="p">)</span>
<span class="n">w</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>

<span class="k">print</span> <span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span>\<span class="n">nWrote</span> <span class="n">output</span><span class="p">.</span><span class="n">m</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span>
<span class="c1">#print(str(llist)) </span></code></pre></figure>

<p>To use this, just run this from the command line:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">python fslevsToMat.py fslevfile1.txt fslevfile2.txt</code></pre></figure>

<p>It will create a file â€˜output.mâ€™ in the working directory. You need to run this script within matlab and then save the resulting cell matrices as a .mat file, then input that file in matlab.</p>

<p>If you need to run the script a lot, consider adding a <a href="https://en.wikipedia.org/wiki/Shebang_(Unix)" target="_blank" rel="noopener noreferrer">#! line</a> specifying your local python executable and placing it somewhere <a href="https://en.wikipedia.org/wiki/PATH_(variable)" target="_blank" rel="noopener noreferrer">within your path variable</a>, so you can just run it.]]&gt;</p>

  </article>

</div>

    </div>

    <!-- Footer -->    
    <footer class="fixed-bottom">
      <div class="container mt-0">
        Â© Copyright 2024 Matthew  Peverill. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="noopener noreferrer">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" target="_blank" rel="noopener noreferrer">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="noopener noreferrer">GitHub Pages</a>.

      </div>
    </footer>

    <!-- JavaScripts -->
    <!-- jQuery -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

    <!-- Bootsrap & MDB scripts -->
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.2/dist/umd/popper.min.js" integrity="sha256-l/1pMF/+J4TThfgARS6KwWrk/egwuVvhRzfLAMQ6Ds4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js" integrity="sha256-SyTu6CwrfOhaznYZPoolVw2rxoY7lKYKQvqbtqN93HI=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script>

    <!-- Masonry & imagesLoaded -->
  <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script>
  <script defer src="/assets/js/masonry.js" type="text/javascript"></script>
    
  <!-- Medium Zoom JS -->
  <script src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script>
  <script src="/assets/js/zoom.js"></script><!-- Load Common JS -->
  <script src="/assets/js/common.js"></script>

    <!-- MathJax -->
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        tags: 'ams'
      }
    };
  </script>
  <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script>
  <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-FZ5N8EW6J2"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-FZ5N8EW6J2');
  </script>
  </body>
</html>

