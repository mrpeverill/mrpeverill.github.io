<!DOCTYPE html>
<html lang="en">

  <!-- Head -->
  <head>    <!-- Metadata, OpenGraph and Schema.org -->
    

    <!-- Standard metadata -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Matthew  Peverill | Neuroimaging Data Compression Part 2: Compression in the real world.</title>
    <meta name="author" content="Matthew  Peverill" />
    <meta name="description" content="Clinical Scientist and  Psychologist in Training 
" />
    <meta name="keywords" content="academic-website, portfolio-website, neuroscience, clinical-psychology" />


    <!-- Bootstrap & MDB -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous" />

    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons">

    <!-- Code Syntax Highlighting -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="none" id="highlight_theme_light" />

    <!-- Styles -->
    
    <link rel="shortcut icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üß†</text></svg>">
    
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="canonical" href="https://matthewpeverill.com/blog/2023/NeuroCompressionComparison_p2/">
    
    <!-- Dark Mode -->
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark" />

    <script src="/assets/js/theme.js"></script>
    <script src="/assets/js/dark_mode.js"></script>
    

  </head>

  <!-- Body -->
  <body class="fixed-top-nav ">

    <!-- Header -->
    <header>

      <!-- Nav Bar -->
      <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top">
        <div class="container">
          <a class="navbar-brand title font-weight-lighter" href="https://matthewpeverill.com/"><span class="font-weight-bold">Matthew</span>   Peverill</a>
          <!-- Navbar Toggle -->
          <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar top-bar"></span>
            <span class="icon-bar middle-bar"></span>
            <span class="icon-bar bottom-bar"></span>
          </button>

          <div class="collapse navbar-collapse text-right" id="navbarNav">
            <ul class="navbar-nav ml-auto flex-nowrap">

              <!-- About -->
              <li class="nav-item ">
                <a class="nav-link" href="/">about</a>
              </li>
              
              <!-- Blog -->
              <li class="nav-item active">
                <a class="nav-link" href="/blog/">blog</a>
              </li>

              <!-- Other pages -->
              <li class="nav-item ">
                <a class="nav-link" href="/projects/">projects</a>
              </li>
              <li class="nav-item ">
                <a class="nav-link" href="/publications/">publications</a>
              </li>
              <li class="nav-item ">
                <a class="nav-link" href="/CV/">vitae</a>
              </li>

              <!-- Toogle theme mode -->
              <div class="toggle-container">
                <a id="light-toggle">
                  <i class="fas fa-moon"></i>
                  <i class="fas fa-sun"></i>
                </a>
              </div>
            </ul>
          </div>
        </div>
      </nav>
    </header>

    <!-- Content -->
    <div class="container mt-5">
      <!-- _layouts/post.html -->

<div class="post">

  <header class="post-header">
    <h1 class="post-title">Neuroimaging Data Compression Part 2: Compression in the real world.</h1>
    <p class="post-meta">May 16, 2023‚Ä¢ Matthew Peverill</p>
    <p class="post-tags">
      <a href="/blog/2023"> <i class="fas fa-calendar fa-sm"></i> 2023 </a>

    </p>
  </header>

  <article class="post-content">
    <p>In a previous episode, we ran benchmarks on a variety of compression
algorithms on a single nifti formatted neuroimaging file. The benchmarks
we used did i/o from and to RAM, so as to allow better ‚Äòtheoretical‚Äô
comparisons of different compression algorithms. We decided that, while
blosc and flzma2 got the best results, lzma2 is a commonly available
option which realizes most of their gains over gzip.</p>

<p>Since that post went live, I‚Äôve been working a lot with lzma2 (via tar
with the -J option to use .tar.xz), and the performance is not quite
what I‚Äôve wanted. The compression ratios are just ok, and it takes a
long time to compress (and doesn‚Äôt seem to use multicore). This may be
because of limitations of the disk, or it could be because I‚Äôm
compressing more than just one file at a time. It could also be because
I‚Äôm not passing the right options to xz. So I wanted to run another
round of comparisons. This time, I want to just run benchmarks in our
analyis environment, using commonly available tools, and measuring
performance of actual bash commands. I‚Äôm only going to evaluate gzip and
lzma2 via xz (bzip2 is antiquated and the rest aren‚Äôt easily available.
But there are a few other things I want to iterate over:</p>

<p><em>Sorting</em>: I want to test a variety of sorting methods. In theory, we
might get better compression if files that have similar patterns of data
(e.g., event files) are compressed sequentially instead of interspersed
amongst other types of files (e.g., images). This is controlled by the
tar command, which globs all the files together before they are
compressed. If the order is different, you can get different results ‚Äì
this can create differences in file size created by, for example,
<a href="https://superuser.com/questions/1633073/why-are-tar-xz-files-15x-smaller-when-using-pythons-tar-library-compared-to-mac" target="_blank" rel="noopener noreferrer">different versions of
tar</a>.
Here are the different methods: * System: the default, just compress
things in the order the system lists them. This may differ across run
and system type. * Name: Sort alphabetically by name * Inode: Sort by
position of the file on disk * Reverse: Reverse the filename like you
were making a palindrome, then sort alphabetically by that list.
Effectively, this sorts by file type given the file extensions present
in BIDS. Tar can‚Äôt do this natively, you have to use a filelist, like
so:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>echo "Making a reverse filelist"
find $TARGET_DIRECTORY -type f &gt; tmp/filelist
rev tmp/filelist | sort | rev &gt; tmp/revfilelist
test_comp "gtar.rv.gz" "tar -czf $testarch -T tmp/revfilelist"
</code></pre></div></div>

<p><em>Threading</em>: I want to test single threaded and 8 thread compression
performance for xz. I might add a 4 core test later if that ends up
being what we need.</p>

<p><em>Block Size</em>: The way multithreading works in xz is that the file is
split in to blocks, which are divied up among the processors. I read <a href="https://yeah.nah.nz/misc/xz-thread/" target="_blank" rel="noopener noreferrer">a
blog post suggesting that changing the size of these blocks could
optimize multithreading</a>, which is
attractive because I haven‚Äôt seen large performance differences from
increasing the number of processors available to XZ.</p>

<h1 id="conclusions--tl-dr">Conclusions / tl; dr:</h1>

<ul>
  <li>
    <p>You <em>can</em> greatly accelerate tar.xz compression to something similar
to what gzip can provide by using multithreading. However, with
smaller datasets/sets of smaller files, you will need to tweak the
block size parameter to realize full benefits.</p>
  </li>
  <li>
    <p>You can improve your compression ratio and compression time a bit by
controlling the order in which tar compresses files. The ideal way is
by processing files in alphabetical order of the reversed lines. If
you want something less cumbersome, simply passing ‚Äìsort=‚Äúname‚Äù to
your tar command will work almost as well. The improvements here are
much smaller than what you get by using multithreading.</p>
  </li>
</ul>

<p>Here are some commands:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>export XZ_OPT="-T8 --block-size=10486760"
tar --sort=name -cJf example.tar.gz target_dir
</code></pre></div></div>

<p>The best part of these optimizations is that they are not using exotic
software: tar and xz are commonly installed on Linux and Mac systems.
The flags I‚Äôm proposing do not in any way complicate decompression ‚Äì a
normal tar -xJf command will work equally well regardless of the options
used to compress the file originally.</p>

<h1 id="generating-the-benchmarks">Generating the benchmarks.</h1>

<p>I used an HTCondor job to compress the same set of files using 17
different methods. I did this once for a set of QC reports output by
fmriprep (mostly as a pilot), and again using BIDS formatted raw data
for one participant from the ABCD dataset. Finally, I ran the benchmarks
for a full set of fmriprep outputs from one ABCD participant. I run the
benchmarks 20 times to account for variability across run conditions.
You can see the full script I used to do this <a href="https://gist.github.com/mrpeverill/645cd9a646119eb05544340e0418af01" target="_blank" rel="noopener noreferrer">on
github</a>,
but the key part of the command is the usage of time to get processing
time for each compression command:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Outputs: realSeconds \t peakMem \t CPUperc
/usr/bin/time -f '%e \t %M \t %P' -ao tmp/timeout.txt
</code></pre></div></div>

<p>Here are a few lines from an example data file:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">Mlabel</th>
      <th style="text-align: center">realSeconds</th>
      <th style="text-align: center">peakMem</th>
      <th style="text-align: center">CPUperc</th>
      <th style="text-align: center">Ratio</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">gtar.df.ra</td>
      <td style="text-align: center">1.89</td>
      <td style="text-align: center">3168</td>
      <td style="text-align: center">16</td>
      <td style="text-align: center">1</td>
    </tr>
    <tr>
      <td style="text-align: center">gtar.df.gz</td>
      <td style="text-align: center">4.70</td>
      <td style="text-align: center">3172</td>
      <td style="text-align: center">97</td>
      <td style="text-align: center">0.537</td>
    </tr>
    <tr>
      <td style="text-align: center">gtar.in.gz</td>
      <td style="text-align: center">4.65</td>
      <td style="text-align: center">3192</td>
      <td style="text-align: center">97</td>
      <td style="text-align: center">0.5371</td>
    </tr>
    <tr>
      <td style="text-align: center">gtar.nm.gz</td>
      <td style="text-align: center">4.62</td>
      <td style="text-align: center">3160</td>
      <td style="text-align: center">98</td>
      <td style="text-align: center">0.537</td>
    </tr>
    <tr>
      <td style="text-align: center">gtar.rv.gz</td>
      <td style="text-align: center">4.59</td>
      <td style="text-align: center">3092</td>
      <td style="text-align: center">98</td>
      <td style="text-align: center">0.5371</td>
    </tr>
    <tr>
      <td style="text-align: center">gtar.df.xz</td>
      <td style="text-align: center">57.17</td>
      <td style="text-align: center">97292</td>
      <td style="text-align: center">97</td>
      <td style="text-align: center">0.431</td>
    </tr>
  </tbody>
</table>

<h1 id="inputs-files">Inputs files</h1>

<p>This dataset includes 4.3 GB of input files for one participant. This
includes images in nifti format and some event files and supporting text
documents.</p>

<p>I‚Äôve omitted error bars when they are unhelpful. One interesting note is
that some variability in compression occurs if you let the system sort
the files for tar.</p>

<p><img src="/assets/img/NeuroCompressionComparison.p2/unnamed-chunk-4-1.png" alt=""><!-- --></p>

<p>Multicore is very unambiguously helpful here. setting the block size
helps a bit more. Let‚Äôs zoom in on the multicore xz options:</p>

<p><img src="/assets/img/NeuroCompressionComparison.p2/unnamed-chunk-5-1.png" alt=""><!-- --></p>

<p>There is too much error to make firm conclusions about speed advantages.
The ‚Äòreverse‚Äô sorting method is marginally better at compressing the
data, but not by much. xz-10MiB still appears to be the best method.</p>

<p><img src="/assets/img/NeuroCompressionComparison.p2/unnamed-chunk-6-1.png" alt=""><!-- --></p>

<p>This explains why xz is so much faster with 10MiB blocks: it is doing a
much better job using the 8 cores we provide for it.</p>

<p><img src="/assets/img/NeuroCompressionComparison.p2/unnamed-chunk-7-1.png" alt=""><!-- --></p>

<h1 id="fmriprep-output">fmriprep output</h1>

<p>19 GB of output files including images in nifti format, CIFTI files,
json, etc.</p>

<p><img src="/assets/img/NeuroCompressionComparison.p2/unnamed-chunk-9-1.png" alt=""><!-- --></p>

<p>There‚Äôs a lot of variability in the timing, but xz-10MiB is marginally
faster. Name sorted xz has the best compression, but there is actually
very little compression available ‚Äì possibly the outputs are already
well compressed.</p>

<p><img src="/assets/img/NeuroCompressionComparison.p2/unnamed-chunk-10-1.png" alt=""><!-- --></p>

<p>With so much data, we can use all of our processors regardless of block
size, which explains why we don‚Äôt see much difference here.</p>

<p><img src="/assets/img/NeuroCompressionComparison.p2/unnamed-chunk-11-1.png" alt=""><!-- --></p>

<h1 id="qc-data-performance">QC data performance</h1>

<p>This data file consists of 74 MB of mostly text: svg and html files
composing a QC report for a typical subject.</p>

<p><img src="/assets/img/NeuroCompressionComparison.p2/unnamed-chunk-13-1.png" alt=""><!-- --></p>

<p>A couple of observations:</p>

<ul>
  <li>XZ compression ratio does not depend very much on sorting or cores
used. There might be a tiny loss of compression in the 10MiB, which is
consistent with findings from the blog post linked above</li>
  <li>Reverse sorting the filenames before we compress them does give us a
fraction of a percentage point more compression. After that, inode is
a the second best.</li>
</ul>

<p><img src="/assets/img/NeuroCompressionComparison.p2/unnamed-chunk-14-1.png" alt=""><!-- --></p>

<p>This explains why xz is so much faster with 10MiB blocks: it is doing a
much better job using the 8 cores we provide for it.</p>

<p><img src="/assets/img/NeuroCompressionComparison.p2/unnamed-chunk-15-1.png" alt=""><!-- --></p>

<p>Again, the 10MiB jobs use more memory to get it done faster.</p>

  </article>

</div>

    </div>

    <!-- Footer -->    
    <footer class="fixed-bottom">
      <div class="container mt-0">
        ¬© Copyright 2024 Matthew  Peverill. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="noopener noreferrer">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" target="_blank" rel="noopener noreferrer">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="noopener noreferrer">GitHub Pages</a>.

      </div>
    </footer>

    <!-- JavaScripts -->
    <!-- jQuery -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

    <!-- Bootsrap & MDB scripts -->
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.2/dist/umd/popper.min.js" integrity="sha256-l/1pMF/+J4TThfgARS6KwWrk/egwuVvhRzfLAMQ6Ds4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js" integrity="sha256-SyTu6CwrfOhaznYZPoolVw2rxoY7lKYKQvqbtqN93HI=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script>

    <!-- Masonry & imagesLoaded -->
  <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script>
  <script defer src="/assets/js/masonry.js" type="text/javascript"></script>
    
  <!-- Medium Zoom JS -->
  <script src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script>
  <script src="/assets/js/zoom.js"></script><!-- Load Common JS -->
  <script src="/assets/js/common.js"></script>

    <!-- MathJax -->
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        tags: 'ams'
      }
    };
  </script>
  <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script>
  <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-FZ5N8EW6J2"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-FZ5N8EW6J2');
  </script>
  </body>
</html>

